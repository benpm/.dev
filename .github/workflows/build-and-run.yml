name: Build and Run Examples

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-c:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc

      - name: Build and run C examples
        id: c-examples
        run: |
          mkdir -p logs/c/examples
          
          for dir in c/*/; do
            example=$(basename "$dir")
            example_dir="logs/c/examples/$example"
            mkdir -p "$example_dir"
            
            if [ -f "$dir/main.c" ]; then
              # Copy source code
              cp "$dir/main.c" "$example_dir/source.c"
              
              # Build and run, capture output
              echo "Building $example..."
              if gcc -o "/tmp/$example" "$dir/main.c" -lm 2>&1; then
                echo "Running $example..."
                timeout 5s "/tmp/$example" 2>&1 | head -100 > "$example_dir/output.txt" || echo "Timed out or error" > "$example_dir/output.txt"
              else
                echo "Build failed" > "$example_dir/output.txt"
              fi
            fi
          done
      
      - name: Upload C logs
        uses: actions/upload-artifact@v4
        with:
          name: c-logs
          path: logs/c/

  build-cpp:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Build and run C++ examples
        id: cpp-examples
        run: |
          mkdir -p logs/cpp/examples
          
          for dir in cpp/*/; do
            example=$(basename "$dir")
            example_dir="logs/cpp/examples/$example"
            mkdir -p "$example_dir"
            
            if [ -f "$dir/main.cpp" ]; then
              # Copy source code
              cp "$dir/main.cpp" "$example_dir/source.cpp"
              
              # Build and run, capture output
              echo "Building $example..."
              if g++ -std=c++20 -o "/tmp/$example" "$dir/main.cpp" 2>&1; then
                echo "Running $example..."
                timeout 5s "/tmp/$example" 2>&1 | head -100 > "$example_dir/output.txt" || echo "Timed out or error" > "$example_dir/output.txt"
              else
                echo "Build failed" > "$example_dir/output.txt"
              fi
            fi
          done
      
      - name: Upload C++ logs
        uses: actions/upload-artifact@v4
        with:
          name: cpp-logs
          path: logs/cpp/

  run-javascript:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run JavaScript examples
        id: js-examples
        run: |
          mkdir -p logs/javascript/examples
          
          for dir in javascript/*/; do
            example=$(basename "$dir")
            example_dir="logs/javascript/examples/$example"
            mkdir -p "$example_dir"
            
            if [ -f "$dir/index.js" ]; then
              # Copy source code
              cp "$dir/index.js" "$example_dir/source.js"
              
              echo "Running $example..."
              timeout 5s node "$dir/index.js" 2>&1 | head -100 > "$example_dir/output.txt" || echo "Timed out or error" > "$example_dir/output.txt"
            elif [ -f "$dir/scenes/main.js" ]; then
              # Copy source code for browser-based examples
              cp "$dir/scenes/main.js" "$example_dir/source.js"
              echo "(Browser-based example - skipped)" > "$example_dir/output.txt"
            fi
          done
      
      - name: Upload JavaScript logs
        uses: actions/upload-artifact@v4
        with:
          name: javascript-logs
          path: logs/javascript/

  run-python:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Python examples
        id: python-examples
        run: |
          mkdir -p logs/python/examples
          
          for dir in python/*/; do
            example=$(basename "$dir")
            example_dir="logs/python/examples/$example"
            mkdir -p "$example_dir"
            
            if [ -f "$dir/main.py" ]; then
              # Copy source code
              cp "$dir/main.py" "$example_dir/source.py"
              
              echo "Running $example..."
              cd "$dir"
              timeout 5s python main.py 2>&1 | head -100 > "../../$example_dir/output.txt" || echo "Timed out or error" > "../../$example_dir/output.txt"
              cd ../..
            fi
          done
      
      - name: Upload Python logs
        uses: actions/upload-artifact@v4
        with:
          name: python-logs
          path: logs/python/

  build-rust:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build and run Rust examples
        id: rust-examples
        run: |
          mkdir -p logs/rust/examples
          
          for dir in rust/*/; do
            example=$(basename "$dir")
            example_dir="logs/rust/examples/$example"
            mkdir -p "$example_dir"
            
            if [ -f "$dir/Cargo.toml" ]; then
              # Copy source code
              if [ -f "$dir/src/main.rs" ]; then
                cp "$dir/src/main.rs" "$example_dir/source.rs"
              fi
              
              echo "Building $example..."
              cd "$dir"
              if cargo build --release 2>&1; then
                echo "Running $example..."
                timeout 5s cargo run --release 2>&1 | head -100 > "../../$example_dir/output.txt" || echo "Timed out or error" > "../../$example_dir/output.txt"
              else
                echo "Build failed" > "../../$example_dir/output.txt"
              fi
              cd ../..
            fi
          done
      
      - name: Upload Rust logs
        uses: actions/upload-artifact@v4
        with:
          name: rust-logs
          path: logs/rust/

  build-nim:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: 'stable'

      - name: Build and run Nim examples
        id: nim-examples
        run: |
          mkdir -p logs/nim/examples
          
          for dir in nim/*/; do
            example=$(basename "$dir")
            example_dir="logs/nim/examples/$example"
            mkdir -p "$example_dir"
            
            if [ -f "$dir/main.nim" ]; then
              # Copy source code
              cp "$dir/main.nim" "$example_dir/source.nim"
              
              echo "Building $example..."
              if nim compile --run "$dir/main.nim" 2>&1 | head -100 > "$example_dir/output.txt"; then
                echo "Success" >> /dev/null
              else
                echo "Build or run failed" > "$example_dir/output.txt"
              fi
            fi
          done
      
      - name: Upload Nim logs
        uses: actions/upload-artifact@v4
        with:
          name: nim-logs
          path: logs/nim/

  generate-pages:
    runs-on: ubuntu-latest
    needs: [build-c, build-cpp, run-javascript, run-python, build-rust, build-nim]
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          path: logs
      
      - name: Setup Zola
        uses: taiki-e/install-action@v2
        with:
          tool: zola@0.19.2

      - name: Generate Zola content
        run: python3 scripts/generate_content.py

      - name: Build site with Zola
        run: |
          cd site
          zola build
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site/public'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
